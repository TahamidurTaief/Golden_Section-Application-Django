{% load static %}
<div class="col-xl-4">
    <div class="" style="top: 20px; z-index: 1;">
        <div class="card border-0 mb-3">
            {% comment %} <div class="card-body p-3">
                <div class="d-flex align-items-center justify-content-between border-bottom mb-3 pb-2">
                    <div class="d-flex align-items-center">
                        <div class="mb-0">											
                            <p class="fs-14 mb-0">Starts From</p>
                            <h4><span class="display-6 fw-bold">$457</span><span class="text-decoration-line-through text-default fs-16"> $875</span></h4>
                        </div>
                    </div>
                    <span class="badge bg-success d-inline-flex align-items-center fw-medium"><i class="ti ti-circle-percentage me-1"></i>50% Offer</span>
                </div>
                <a href="{% url 'core:service_request' %}" class="btn btn-primary w-100 d-flex align-items-center justify-content-center mb-2"><i class="ti ti-calendar me-2"></i>Book Service</a>
                <a href="javascript:void(0);" data-bs-toggle="modal" data-bs-target="#add-enquiry" class="btn btn-outline-light d-flex align-items-center justify-content-center w-100"><i class="ti ti-mail me-2"></i>Send Enquiry</a>
            </div> {% endcomment %}
        </div>
        <div class="card border-0 mb-3">
            <div class="card-body p-3">
                <h4 class="mb-3">Service Provider</h4>
                <div class="provider-info text-center bg-light-500 p-3 mb-3 rounded">
                    <div class="avatar avatar-xl mb-2">
                        {% if service.provider.business_logo %}
                            <img src="{{ service.provider.logo_card.url }}" alt="{{ service.provider.business_name }} logo" class="img-fluid rounded-circle">
                        {% else %}
                            <img src="{% static 'img/profiles/avatar-02.jpg' %}" alt="{{ service.provider.business_name }} profile" class="img-fluid rounded-circle">
                        {% endif %}
                        {% if service.provider.is_verified %}
                        <span class="service-active-dot"><i class="ti ti-check"></i></span>
                        {% endif %}
                    </div>
                    <h5 class="mb-1">{{ service.provider.business_name }}</h5>
                    <p class="fs-14 mb-0"><i class="ti ti-star-filled text-warning me-2"></i><span class="text-gray-9 fw-semibold">{{ service.provider.rating|floatformat:1 }}</span> ({{ service.provider.total_reviews }} reviews)</p>
                </div>
                <div class="d-flex align-items-center justify-content-between mb-2">
                    <h6 class="fs-16 fw-medium mb-0"><i class="ti ti-calendar-check text-primary me-2"></i>Member Since</h6>
                    <p class="mb-0 fw-semibold">{{ service.provider.user.date_joined|date:"d M Y" }}</p>
                </div>
                <div class="d-flex align-items-center justify-content-between mb-2">
                    <h6 class="fs-16 fw-medium mb-0"><i class="ti ti-briefcase text-info me-2"></i>Total Jobs</h6>
                    <p class="mb-0 fw-semibold">{{ service.provider.total_jobs }}</p>
                </div>
                <div class="d-flex align-items-center justify-content-between mb-2">
                    <h6 class="fs-16 fw-medium mb-0"><i class="ti ti-circle-check text-success me-2"></i>Completed</h6>
                    <p class="mb-0 fw-semibold">{{ service.provider.total_completed_jobs }}</p>
                </div>
                <div class="d-flex align-items-center justify-content-between mb-2">
                    <h6 class="fs-16 fw-medium mb-0"><i class="ti ti-percentage text-warning me-2"></i>Success Rate</h6>
                    <p class="mb-0 fw-semibold">{{ service.provider.success_rate }}%</p>
                </div>
                <div class="d-flex align-items-center justify-content-between mb-2">
                    <h6 class="fs-16 fw-medium mb-0"><i class="ti ti-star-filled text-warning me-2"></i>Rating</h6>
                    <p class="mb-0 fw-semibold">{{ service.provider.rating|floatformat:1 }} / 5.0</p>
                </div>
                <div class="d-flex align-items-center justify-content-between mb-3">
                    <h6 class="fs-16 fw-medium mb-0"><i class="ti ti-message-circle text-info me-2"></i>Reviews</h6>
                    <p class="mb-0 fw-semibold">{{ service.provider.total_reviews }}</p>
                </div>
                <div class="border-top pt-3">
                    <button type="button" class="btn btn-dark w-100" id="confirmServiceBtn" onclick="confirmService()">
                        <i class="ti ti-calendar-check me-2"></i>Confirm Service
                    </button>
                </div>
                
                <!-- Hidden form to pass data to booking page -->
                <form id="bookingForm" action="{% url 'core:booking' service.id %}" method="POST">
                    {% csrf_token %}
                    <input type="hidden" name="selected_sub_services" id="selected_sub_services">
                </form>
            </div>
        </div>
        {% if business_hours %}
        <div class="card border-0 mb-3">
            <div class="card-body p-3">
                <h4 class="mb-3">Business Hours</h4>
                {% for hours in business_hours %}
                <div class="d-flex align-items-center justify-content-between {% if not forloop.last %}mb-2{% else %}mb-0{% endif %}">
                    <h6 class="fs-16 fw-medium mb-0">{{ hours.get_weekday_display }}</h6>
                    {% if hours.is_closed %}
                        <p class="text-danger mb-0">Closed</p>
                    {% else %}
                        <p class="mb-0">{{ hours.opening_time|time:"g:i A" }} - {{ hours.closing_time|time:"g:i A" }}</p>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        <!-- Confirm Service Script -->
        <script>
        function confirmService() {
            // Collect selected sub-services
            const selectedSubServices = [];
            document.querySelectorAll('input[id^="service_"]:checked').forEach(checkbox => {
                const serviceId = checkbox.id.replace('service_', '');
                const serviceName = checkbox.closest('.d-flex').querySelector('.fw-medium')?.textContent.trim() || '';
                selectedSubServices.push({
                    id: serviceId,
                    name: serviceName
                });
            });
            
            // Check if at least one sub-service is selected
            if (selectedSubServices.length === 0) {
                alert('Please select at least one service from the "Services Offered" section.');
                // Scroll to services offered section
                document.querySelector('#servicesOffered')?.scrollIntoView({ behavior: 'smooth' });
                return;
            }
            
            // Populate hidden form fields
            document.getElementById('selected_sub_services').value = JSON.stringify(selectedSubServices);
            
            // Debug: Log the data being sent
            console.log('Submitting booking data:', {
                service_id: '{{ service.id }}',
                service_name: '{{ service.name }}',
                provider_id: '{{ service.provider.id }}',
                provider_name: '{{ service.provider.business_name }}',
                selected_sub_services: selectedSubServices
            });
            
            // Submit the form - location will be selected on booking page
            document.getElementById('bookingForm').submit();
        }
        </script>
        
        <a href="#" class="text-danger fs-14 d-block text-center mt-3"><i class="ti ti-pennant-filled me-2"></i>Report Provider</a>
    </div>
</div>