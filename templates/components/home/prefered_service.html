{% load static %}

<section class="section pt-0 pb-0" x-data="{ selectedCategory: 'all' }">
    <div class="container">
		<div class="position-relative mb-4">
			<div class="text-center">
				<h2 class="mb-1">Most <span class="text-linear-primary">Preferred Services</span></h2>
				<p class="sub-title mb-0">Our top-rated and most booked services</p>
			</div>
			<div class="position-absolute top-0 end-0">
				<a href="{% url 'services:list' %}" hx-get="{% url 'services:list' %}" hx-target="body" hx-push-url="true" class="btn btn-link text-decoration-none d-flex align-items-center see-more">
					<span>See more</span>
					<i class="ti ti-arrow-right ms-2"></i>
				</a>
			</div>
		</div>

		<!-- Category Filter Buttons -->
		<div class="mb-4 d-flex justify-content-center flex-wrap gap-2">
			<button 
				@click="selectedCategory = 'all'"
				:class="selectedCategory === 'all' ? 'btn-primary' : 'btn-outline-secondary'"
				class="btn btn-sm rounded-pill px-4"
				hx-get="{% url 'core:filter_preferred_services' %}?category=all"
				hx-target="#preferred-services-container"
				hx-swap="innerHTML"
				style="transition: all 0.3s;">
				All Services
			</button>
			{% for category in featured_categories %}
			<button 
				@click="selectedCategory = '{{ category.slug }}'"
				:class="selectedCategory === '{{ category.slug }}' ? 'btn-primary' : 'btn-outline-secondary'"
				class="btn btn-sm rounded-pill px-4"
				hx-get="{% url 'core:filter_preferred_services' %}?category={{ category.slug }}"
				hx-target="#preferred-services-container"
				hx-swap="innerHTML"
				style="transition: all 0.3s;">
				{{ category.name }}
			</button>
			{% endfor %}
		</div>

        <div id="preferred-services-container">
			{% include 'components/home/preferred_services_partial.html' %}
		</div>
    </div>
</section>

<script>
    function carouselComponent(opts){
        return {
            current: 0,
            count: opts.count || 0,
            perSlide: 4,
            breakpoints: opts.breakpoints || {1200:4, 992:3, 768:2, 0:1},
            autoplayInterval: null,
            init() {
                this.updatePerSlide();
                window.addEventListener('resize', () => this.updatePerSlide());
            },
            updatePerSlide() {
                const width = window.innerWidth;
                for (let [breakpoint, slides] of Object.entries(this.breakpoints).sort((a, b) => b[0] - a[0])) {
                    if (width >= parseInt(breakpoint)) {
                        this.perSlide = slides;
                        break;
                    }
                }
                if (this.current >= Math.ceil(this.count / this.perSlide)) {
                    this.current = 0;
                }
            },
            prev() {
                this.current = this.current > 0 ? this.current - 1 : Math.max(0, Math.ceil(this.count / this.perSlide) - 1);
            },
            next() {
                this.current = this.current < Math.ceil(this.count / this.perSlide) - 1 ? this.current + 1 : 0;
            },
            goTo(index) {
                this.current = index;
            },
            startAutoplay() {
                this.autoplayInterval = setInterval(() => this.next(), 5000);
            },
            stopAutoplay() {
                if (this.autoplayInterval) {
                    clearInterval(this.autoplayInterval);
                }
            }
        }
    }
</script>